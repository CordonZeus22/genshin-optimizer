(function(){"use strict";const b=(e,a,t)=>e<a?a:e>t?t:e,P=e=>b(e,0,1);function _(e,a){return Object.fromEntries(e.map((t,n)=>[t,a(t,n)]))}const d=["hp","atk","def","hp_","atk_","def_","pen","crit_","crit_dmg_","anomProf"],m=["hp","atk","def","hp_","atk_","def_","crit_","crit_dmg_","anomProf",...["electric_dmg_","fire_dmg_","ice_dmg_","physical_dmg_","ether_dmg_"],"pen_","anomMas_","impact_","enerRegen_"];Array.from(new Set([...d,...m]));const f={AstralVoice:{atk:.1},BranchBladeSong:{crit_dmg_:.16},ChaosJazz:{anomProf:30},ChaoticMetal:{ether_dmg_:10},FangedMetal:{physical_dmg_:.1},FreedomBlues:{anomProf:30},HormonePunk:{atk:.1},InfernoMetal:{fire_dmg_:.1},PolarMetal:{ice_dmg_:.1},ProtoPunk:{shield_:.15},PufferElectro:{pen_:.08},ShockstarDisco:{impact_:.06},SoulRock:{def_:.16},SwingJazz:{enerRegen_:.2},ThunderMetal:{electric_dmg_:.1},WoodpeckerElectro:{crit_:.08}},F=["charLvl","enemyDef","enemyDefRed_","enemyRes_","enemyResRed_","enemyResIgn_","dmg_","impact","anomMas","shield_"];Array.from(new Set([...m,...d,...F]));const A=["electric_dmg_","fire_dmg_","ice_dmg_","physical_dmg_","ether_dmg_"],u=["burn","shock","corruption","shatter","assault"];({..._(u,e=>`${e} DMG Bonus`)},Object.entries({electric:"Electric",fire:"Fire",ice:"Ice",physical:"Physical",ether:"Ether"}).forEach(([e,a])=>{}));function K(e,a){const t={...e},n=i=>t[i]||0;for(const i of a)for(const o in i.stats)t[o]=n(o)+i.stats[o];for(const[i,o]of Object.entries(t))if(o>=2&&f[i])for(const[c,r]of Object.entries(f[i]))t[c]=n(c)+r;return t.initial_hp=n("hp_base")*(1+n("hp_"))+n("hp"),t.initial_atk=n("atk_base")*(1+n("atk_"))+n("atk"),t.initial_def=n("def_base")*(1+n("def_"))+n("def"),t.final_hp=n("initial_hp")*(1+n("cond_hp_"))+n("cond_hp"),t.final_atk=n("initial_atk")*(1+n("cond_atk_"))+n("cond_atk"),t.final_def=n("initial_def")*(1+n("cond_def_"))+n("cond_def"),t.impact=n("impact")*(1+n("impact_")),t.anomMas=n("anomMas")*(1+n("anomMas_")),t.crit_=P(t.crit_),t}function B(e,a){return I[a](e)??0}const I={initial_atk:e=>e.initial_atk||0,..._(A,e=>a=>{const t=n=>a[n]||0;return t("final_atk")*(1+t(e)+t("dmg_"))*(1+t("crit_")*t("crit_dmg_"))*p(t)*y(t)}),..._(u,e=>a=>{const t=n=>a[n]||0;return H[e]*t("final_atk")*(t("anomProf")*.01)*(1+1/59*(t("charLvl")-1))*(1+t(v[e])+t("dmg_"))*p(t)*y(t)})};function p(e){const a=T(e("charLvl"));return a/(Math.max(e("enemyDef")*(1-e("enemyDefRed_"))*(1-e("pen_"))-e("pen"),0)+a)}function y(e){return 1-e("enemyRes_")+e("enemyResRed_")+e("enemyResIgn_")}function T(e){return C[e]||794}const C={1:50,2:54,3:58,4:62,5:66,6:71,7:76,8:82,9:88,10:94,11:100,12:107,13:114,14:121,15:129,16:137,17:145,18:153,19:162,20:172,21:181,22:191,23:201,24:211,25:222,26:233,27:245,28:256,29:268,30:281,31:293,32:306,33:319,34:333,35:347,36:361,37:375,38:390,39:405,40:421,41:436,42:452,43:469,44:485,45:502,46:519,47:537,48:555,49:573,50:592,51:610,52:629,53:649,54:669,55:689,56:709,57:730,58:751,59:772,60:794},v={burn:"fire_dmg_",shock:"electric_dmg_",corruption:"ether_dmg_",shatter:"ice_dmg_",assault:"physical_dmg_"},H={burn:.5,shock:1.25,corruption:.625,shatter:5,assault:7.13},g=5e4,L=2e5;let s,h,k,D;onmessage=async e=>{try{await O(e)}catch(a){console.error(a),postMessage({resultType:"err",message:JSON.stringify(a)})}};async function O(e){const{data:a}=e,{command:t}=a;switch(t){case"init":j(a);break;case"start":await z();break}}async function j({baseStats:e,discStatsBySlot:a,constraints:t,formulaKey:n}){k=e,s=a,h=t,D=n,postMessage({resultType:"initialized"})}function*w(){for(const e of s[1])for(const a of s[2])for(const t of s[3])for(const n of s[4])for(const i of s[5])for(const o of s[6])yield{d1:e,d2:a,d3:t,d4:n,d5:i,d6:o}}async function z(){let e=[],a=0;function t(){const i=e.length;e.length>g&&(e.sort((o,c)=>c.value-o.value),e=e.slice(0,g)),postMessage({resultType:"results",builds:e,numBuildsComputed:i+a}),e=[],a=0}const n=Object.entries(h);for(const{d1:i,d2:o,d3:c,d4:r,d5:M,d6:E}of w()){const l=K(k,[i,o,c,r,M,E]);n.every(([R,{value:S,isMax:N}])=>N?l[R]<=S:l[R]>=S)?e.push({value:B(l,D),discIds:{1:i.id,2:o.id,3:c.id,4:r.id,5:M.id,6:E.id}}):a++,e.length>L&&t()}e.length>0&&t(),postMessage({resultType:"done"})}})();
