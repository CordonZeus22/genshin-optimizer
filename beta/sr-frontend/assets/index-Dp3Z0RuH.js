import{c8 as F,c9 as C,ca as I,be as E,bf as R,cb as V,cc as G,al as g,bh as K,cd as J,ce as L,cf as U,cg as P,bp as W,bo as X,a6 as p,ch as f,ci as H,aj as j,cj as Q,ck as Y,cl as Z,cm as tt,cn as et,co as st,cp as q,cq as v,cr as rt}from"./index-SHvKIHba.js";const at={};class D{constructor(t,e){this.root=new nt(t,e)}subset(t){const e=[];return this._subset(t,n=>e.push(...n[F])),e}_subset(t,e){const n=t.length;function o(r,s){r<n?s.subset(t[r]).forEach(i=>o(r+1,i)):e(s.leaf)}o(0,this.root)}}let nt=class N{constructor(t,e){if(this.children=[],t>0)for(const[n,o]of Object.entries(e)){const r=new Map;for(const[s,i]of Object.entries(o))r.set(+s,new N(t-1,i));this.children.push({mask:+n,map:r})}else this.leaf=e}subset(t){return this.children.map(({mask:e,map:n})=>n.get(t&e)).filter(e=>!!e)}};class _{constructor(t){this.root=new k(void 0),this.keys=t}at(t){const e=this.keys.get(t),n=e.reduce((o,r)=>o.child(r),this.root);return n.leaf||(n.leaf=new O(t,e,this.keys,n)),n.leaf}}class k{constructor(t){this.children=new Map,this.parent=t}child(t){let e=this.children.get(t);return e||(e=new k(this),this.children.set(t,e),e)}}class O{constructor(t,e,n,o){this.tag=Object.fromEntries(Object.entries(t).filter(([r,s])=>s!=null)),this.id=e,this.keys=n,this.internal=o}with(t){const{keys:e}=this,{id:n,firstReplacedByte:o}=e.combine(this.id,t);let r=this.internal;for(let s=o;s<e.tagLen;s++)r=r.parent;for(let s=o;s<e.tagLen;s++)r=r.child(n[s]);return r.leaf||(r.leaf=new O({...this.tag,...t},n,e,r)),r.leaf}}class ot{constructor(t,e){this.keys=new C(t),this.values=new D(t.tagLen,e)}subset(t){return this.values.subset(this.keys.get(t))}}const y={sum:a=>a.reduce((t,e)=>t+e,0),prod:a=>a.reduce((t,e)=>t*e,1),min:a=>Math.min(...a),max:a=>Math.max(...a),sumfrac:([a,t])=>a/(a+t),unique:([a])=>a},M={match:([a,t])=>a===t?0:1,thres:([a,t])=>a>=t?0:1,lookup:([a],t)=>t[a]??0},w=a=>G(a,"val");let B=class{constructor(t,...e){const n=new C(t);this.nodes=new D(n.tagLen,I(e)),this.cache=new _(n).at({}),this.calc=new _(n).at({}),this.calc.val=this}withTag(t){const e=this.calc.with(t);return e.val??(e.val=Object.assign(new this.constructor(this.cache.keys),this,{cache:this.cache.with(t),calc:e}))}gather(t){return this._gather(this.cache.with(t)).pre}compute(t){return this._compute(t,this.cache)}_gather(t){if(t.val)return t.val;const e=this.nodes.subset(t.id).flatMap(n=>n.op==="reread"?this._gather(t.with(n.tag)).pre:[this.markGathered(t.tag,n,this._compute(n,t))]);return t.val={pre:e}}_compute(t,e){const n=(r,s,i,c)=>Object.freeze({val:r,meta:this.computeMeta(t,r,s,i,c)}),{op:o}=t;switch(o){case"const":return n(t.ex,[],[]);case"sum":case"prod":case"min":case"max":case"sumfrac":{const r=t.x.map(s=>this._compute(s,e));return n(y[o](w(r),t.ex),r,[])}case"thres":case"match":case"lookup":{const r=t.br.map(u=>this._compute(u,e)),s=M[o](w(r),t.ex),i=[...Array(t.x.length)],c=i[s]=this._compute(t.x[s],e);return n(c.val,i,r)}case"subscript":{const r=this._compute(t.br[0],e);return n(t.ex[r.val],[],[r])}case"vtag":return n(e.tag[t.ex]??"",[],[]);case"tag":{const r=e.with(t.tag),s=this._compute(t.x[0],r);return n(s.val,[s],[],r.tag)}case"dtag":{const r=t.br.map(c=>this._compute(c,e)),s=e.with(Object.fromEntries(r.map((c,u)=>[t.ex[u],c.val]))),i=this._compute(t.x[0],s);return n(i.val,[i],r,s.tag)}case"read":{const r=e.with(t.tag),s=this._gather(r),{pre:i}=s,c=t.ex??"unique";if(s[c])return s[c];if(R()&&c==="unique"&&i.length!==1)throw new Error(`Ill-form read for ${V(r.tag)}`);const u=y[c](w(i),void 0);return s[c]=n(u,i,[],r.tag)}case"custom":{const r=t.x.map(s=>this._compute(s,e));return n(at[t.ex].calc(w(r)),r,[])}default:E(o)}}markGathered(t,e,n){return n}computeMeta(t,e,n,o,r){}toDebug(){throw"Not implemented"}};function wt(a,t,e){function n(s,i){if(s.val)return s.val;const c=e(s.tag);return s.val=c?[K(c,i)]:t.nodes.subset(s.id).flatMap(u=>u.op!=="reread"?r(u,s):n(s.with(u.tag),i)),s.val}function o(s,i,c){return s.every(u=>u.op==="const")?g(y[i](s.map(u=>u.ex),c)):{op:i,x:s,br:[]}}function r(s,i){const{op:c}=s;switch(c){case"const":return s;case"read":{const u=n(i.with(s.tag),s.ex);return s.ex===void 0?u[0]??g(void 0):o(u,s.ex,s.ex)}case"sum":case"prod":case"min":case"max":case"sumfrac":{const u=s.x.map(l=>r(l,i));return o(u,c,s.ex)}case"thres":case"match":case"lookup":{const u=s.br.map(l=>r(l,i));if(u.every(l=>l.op==="const")){const l=M[s.op](u.map(m=>m.ex),s.ex);return r(s.x[l],i)}return{...s,x:s.x.map(l=>r(l,i)),br:u}}case"subscript":{const u=r(s.br[0],i);return u.op==="const"?g(s.ex[u.ex]):{...s,br:[u]}}case"vtag":return g(i.tag[s.ex]??"");case"tag":return r(s.x[0],i.with(s.tag));case"dtag":{const u=s.br.map(m=>r(m,i));if(u.some(m=>m.op!=="const"))throw new Error("Dynamic tag must be resolvable during detachment");const l=i.with(Object.fromEntries(u.map((m,h)=>[s.ex[h],m.ex])));return r(s.x[0],l)}case"custom":return{...s,x:s.x.map(u=>r(u,i))};default:E(c)}}return a.map(s=>r(s,new _(t.cache.keys).at({})))}function bt(a,t){const e=new Map;function n(o){const r=e.get(o);if(r)return r;const s=o,i=b(o.x,n),c=b(o.br,n);(o.x!==i||o.br!==c)&&(o={...o,x:i,br:c});const u=t(o,s);return e.set(o,u),u}return b(a,n)}function it(a,t){const e=new Map;function n(o){const r=e.get(o);if(r)return r;const s=t(o,n);return e.set(o,s),s}return b(a,n)}function vt(a,t){const e=new Set;function n(o){e.has(o)||(t(o,n),e.add(o))}a.forEach(n)}function b(a,t){const e=a.map(t);return a.every((n,o)=>n===e[o])?a:e}const ct={arithmetic:y,branching:M};class ut extends B{constructor(t,e,n=()=>!0){super(t.cache.keys),this.gathering=new Set,this.nodes=t.nodes,this.tagStr=e,this.filter=n,this.cache=this.cache.with(t.cache.tag)}withTag(t){throw new Error("Unimplemented")}_gather(t){if(this.gathering.has(t))throw new Error("Loop detected");this.gathering.add(t);const e=this.__gather(t);return this.gathering.delete(t),e}__gather(t){if(t.val)return t.val;const e=[];this.nodes._subset(t.id,o=>e.push(...o[J]??[]));const n=this.nodes.subset(t.id).flatMap((o,r)=>o.op==="reread"?this._gather(t.with(o.tag)).pre.map(s=>[s,o,r]):[[this._compute(o,t),o,r]]).map(([o,r,s])=>this.markGathered(t.tag,r,o,e[s]));return t.val={pre:n}}_compute(t,e){try{return super._compute(t,e)}catch(n){return{val:NaN,meta:{formula:`err: ${n.message} in ${this.tagStr(e.tag)}: ${T(t,this.tagStr)}`,deps:[],isRead:!0,toJSON:$(this.tagStr)}}}}markGathered(t,e,{val:n,meta:o},r){return o={...o,readSeq:[...o.readSeq??[],r]},Object.freeze({val:n,meta:o})}computeMeta(t,e,n,o,r){typeof e!="number"?e=`"${e}"`:Math.round(e)===e?e=`${e}`:e=e.toFixed(2);const s={formula:`[${e}] ${T(t,this.tagStr)}`,deps:[...n.map(i=>i==null?void 0:i.meta).filter(i=>!!i),...o.map(i=>i.meta)].flatMap(i=>i.isRead?[i]:i.deps),isRead:t.op==="read",toJSON:$(this.tagStr)};if(t.op==="read"){r=Object.fromEntries(Object.entries(r).filter(([u,l])=>l)),s.deps=n.map(u=>u.meta);const i=s.deps.length;s.deps=s.deps.filter(this.filter);const c=i-s.deps.length;s.formula=`gather ${n.length} node(s) (${c} filtered) for ${this.tagStr(t.tag)} (${this.tagStr(r)})`}return s}}function T(a,t=e=>JSON.stringify(e)){return it([a],(e,n)=>{const{op:o,tag:r,br:s,x:i}=e;let{ex:c}=e;if(o==="const")return`${c}`;if(o==="read")return t(r,c);o==="subscript"&&(c=void 0);const u=[];return c&&u.push(JSON.stringify(c)),r&&u.push(t(r)),u.push(...s.map(n),...i.map(n)),`${o}(`+u.join(", ")+")"})[0]}function $(a){return function(){const{readSeq:t,formula:e,deps:n}=this;let o;if(t!=null&&t.some(r=>!!r)){const[r,...s]=t;let i="";for(let c=s.length-1;c>=0;c--)if(s[c]){const{tag:u,value:l}=s[c];i+=`${a(u)} <= ${a(l.tag)} : `}else i+="!! : ";o=i+(r?`matches ${a(r.tag)}`:"!!")}return{...o&&{readSeq:o},formula:e,deps:n}}}const{arithmetic:lt}=ct;let ht=class extends B{computeMeta({op:t,ex:e},n,o,r,s){const i={...Object.freeze({conds:Object.freeze({})})},c=o.filter(h=>!!h).map(h=>S(h,i));r.forEach(h=>S(h,i));function u(h,d){return!d.tag&&h?{tag:h,...d}:d}function l(h,d){return u(s,{op:h,ops:d,...i})}function m(h){const d=h.meta,x=d.conds===i.conds;return u(s,x?d:{...d,...i})}if(t==="read"&&e!==void 0){if(e==="min"||e==="max")return m(c.find(h=>h.val===n));t=e,e=void 0}switch(t){case"sum":case"prod":case"min":case"max":case"sumfrac":{let h=c;if(h.length>1){const d=lt[t]([],e);h=h.filter(x=>x.val!==d)}return h.length===1?m(h[0]):h.length===0?l("const",[]):l(t,h)}case"const":case"vtag":case"subscript":return l("const",[]);case"match":case"thres":case"lookup":case"tag":case"dtag":return m(c[0]);case"read":return Object.freeze(m(c[0]));case"custom":return l(e,c);default:L(t)}}markGathered(t,e,n){let o=!1;const r=n.val,s={...Object.freeze(n.meta)};if(t.qt==="cond"){const{src:i,dst:c,sheet:u,q:l}=t;i&&u&&l&&(s.conds={[c??"All"]:{[i]:{[u]:{[l]:r}}}}),o=!0}return Object.freeze(s),o?{val:r,meta:s}:n}listFormulas(t){return this.gather(t.tag).filter(e=>e.val).map(({val:e,meta:n})=>U.withTag(n.tag)[e])}listCondFormulas(t){return this.listFormulas(t).map(e=>this.compute(e).meta.conds).reduce(z,{})}};function S(a,t){const{conds:e,...n}=a.meta;return t.conds=z(t.conds,e),Object.isFrozen(a.meta)?a:{val:a.val,meta:n}}function z(a,t){return A(a,t,(e,n)=>typeof n=="number"?n:void 0)}function A(a,t,e){const n=e(a,t);if(n!==void 0)return n;if(Object.keys(a).length<Object.keys(t).length&&([a,t]=[t,a]),!Object.keys(t).length)return a;let o=!1;const r={...a};for(const[s,i]of Object.entries(t)){const c=r[s],u=s in r?A(c,i,e):i;c!==u&&(r[s]=u,o=!0)}return o?r:a}function dt(a){return t=>!ft(t,a)}function ft(a,t){var r,s;if(!a.formula||!a.deps||a.deps.length<1)return!1;const e=a.formula,n=e.includes("[0]")&&e.includes("common.count")&&t.some(i=>e.includes(i)),o=((r=a.deps[0].formula)==null?void 0:r.includes("gather 0 node"))&&((s=a.deps[0].formula)==null?void 0:s.includes("common.count"));return n&&o}class mt extends ht{toDebug(){return new ut(this,P,dt([...W,...X]))}}function xt(a,...t){return t.map(({tag:e,value:n})=>({tag:{...e,preset:a},value:n}))}function _t(a,...t){return t.map(({tag:e,value:n})=>({tag:{...e,src:a},value:n}))}function kt(a,t){const{lvl:e,basic:n,skill:o,ult:r,talent:s,ascension:i,eidolon:c,teamPosition:u}=p.char,{char:l,iso:m,[a.key]:h}=f.withAll("sheet",[]);return[l.reread(h),m.reread(h),e.add(a.level),n.add(a.basic),o.add(a.skill),r.add(a.ult),s.add(a.talent),i.add(a.ascension),c.add(a.eidolon),u.add(t),...H.map(d=>j.char[`statBoost${d}`].add(a.statBoosts[d]?1:0)),...Q.map(d=>j.char[`bonusAbility${d}`].add(a.bonusAbilities[d]?1:0))]}function Ot(a,t,e,n){return[f.sheet("agg").reread(f.sheet("lightCone")),p.common.count.sheet(a).add(1),p.lightCone.lvl.add(t),p.lightCone.ascension.add(e),p.lightCone.superimpose.add(n)]}function Mt(a,t){const{common:{count:e},premod:n}=tt(et,{sheet:"relic",et:"own"});return[f.sheet("agg").reread(f.sheet("relic")),f.withTag({sheet:"relic",qt:"premod"}).reread(f.sheet("dyn")),...Object.entries(a).map(([o,r])=>st(n,o).sheet("dyn").add(r)),...Object.entries(t).map(([o,r])=>e.sheet(o).add(r))]}function jt(a){const t=f.with("et","team"),{own:e,enemy:n,teamBuff:o,notOwnBuff:r}=f.sheet("agg").withAll("et",[]);return[a.map(s=>f.withTag({et:"target",dst:s}).reread(f.withTag({et:"own",dst:null,src:s}))),a.flatMap(s=>{const i=e.with("src",s);return a.map(c=>i.reread(o.withTag({dst:s,src:c,name:null})))}),a.flatMap(s=>{const i=e.with("src",s);return a.filter(c=>c!==s).map(c=>i.reread(r.withTag({dst:s,src:c,name:null})))}),a.map(s=>n.reread(f.withTag({et:"enemyDeBuff",dst:null,src:s,name:null}))),a.flatMap((s,i)=>{const{stackIn:c,stackTmp:u}=f.withAll("qt",[]),l=f.withTag({src:s,et:"own"});return[l.with("qt","stackTmp").add(Y(c,0,i+1)),l.with("qt","stackOut").add(Z(u.max.with("et","team"),i+1,c))]}),a.map(s=>t.add(f.withTag({src:s,et:"own"}).sum))].flat()}function Tt(a){const t=q(v,a);return new mt(v,rt,t)}function $t(a){return new ot(v,q(v,a))}export{_t as a,ct as b,kt as c,vt as d,at as e,wt as f,$t as g,Ot as l,bt as m,Mt as r,Tt as s,jt as t,xt as w};
