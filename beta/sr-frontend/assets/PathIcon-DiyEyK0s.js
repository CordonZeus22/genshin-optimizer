import{c3 as R,c4 as q,c5 as V,b8 as I,b9 as G,c6 as K,c7 as J,al as w,bb as L,c8 as U,c9 as H,ca as W,cb as X,bj as Q,bi as Y,a6 as g,cc as f,cd as Z,aj as T,ce as P,cf as tt,cg as et,ch as st,ci as rt,cj as at,ck as D,cl as v,cm as nt,o as p,cn as $,co as ot,cp as it,cq as ct,cr as ut,cs as lt,ct as ht}from"./index-3b67VH4-.js";const dt={};class N{constructor(t,e){this.root=new ft(t,e)}subset(t){const e=[];return this._subset(t,n=>e.push(...n[R])),e}_subset(t,e){const n=t.length;function o(a,s){a<n?s.subset(t[a]).forEach(i=>o(a+1,i)):e(s.leaf)}o(0,this.root)}}let ft=class A{constructor(t,e){if(this.children=[],t>0)for(const[n,o]of Object.entries(e)){const a=new Map;for(const[s,i]of Object.entries(o))a.set(+s,new A(t-1,i));this.children.push({mask:+n,map:a})}else this.leaf=e}subset(t){return this.children.map(({mask:e,map:n})=>n.get(t&e)).filter(e=>!!e)}};class k{constructor(t){this.root=new O(void 0),this.keys=t}at(t){const e=this.keys.get(t),n=e.reduce((o,a)=>o.child(a),this.root);return n.leaf||(n.leaf=new M(t,e,this.keys,n)),n.leaf}}class O{constructor(t){this.children=new Map,this.parent=t}child(t){let e=this.children.get(t);return e||(e=new O(this),this.children.set(t,e),e)}}class M{constructor(t,e,n,o){this.tag=Object.fromEntries(Object.entries(t).filter(([a,s])=>s!=null)),this.id=e,this.keys=n,this.internal=o}with(t){const{keys:e}=this,{id:n,firstReplacedByte:o}=e.combine(this.id,t);let a=this.internal;for(let s=o;s<e.tagLen;s++)a=a.parent;for(let s=o;s<e.tagLen;s++)a=a.child(n[s]);return a.leaf||(a.leaf=new M({...this.tag,...t},n,e,a)),a.leaf}}class mt{constructor(t,e){this.keys=new q(t),this.values=new N(t.tagLen,e)}subset(t){return this.values.subset(this.keys.get(t))}}const x={sum:r=>r.reduce((t,e)=>t+e,0),prod:r=>r.reduce((t,e)=>t*e,1),min:r=>Math.min(...r),max:r=>Math.max(...r),sumfrac:([r,t])=>r/(r+t),unique:([r])=>r},j={match:([r,t])=>r===t?0:1,thres:([r,t])=>r>=t?0:1,lookup:([r],t)=>t[r]??0},b=r=>J(r,"val");let B=class{constructor(t,...e){const n=new q(t);this.nodes=new N(n.tagLen,V(e)),this.cache=new k(n).at({}),this.calc=new k(n).at({}),this.calc.val=this}withTag(t){const e=this.calc.with(t);return e.val??(e.val=Object.assign(new this.constructor(this.cache.keys),this,{cache:this.cache.with(t),calc:e}))}gather(t){return this._gather(this.cache.with(t)).pre}compute(t){return this._compute(t,this.cache)}_gather(t){if(t.val)return t.val;const e=this.nodes.subset(t.id).flatMap(n=>n.op==="reread"?this._gather(t.with(n.tag)).pre:[this.markGathered(t.tag,n,this._compute(n,t))]);return t.val={pre:e}}_compute(t,e){const n=(a,s,i,c)=>Object.freeze({val:a,meta:this.computeMeta(t,a,s,i,c)}),{op:o}=t;switch(o){case"const":return n(t.ex,[],[]);case"sum":case"prod":case"min":case"max":case"sumfrac":{const a=t.x.map(s=>this._compute(s,e));return n(x[o](b(a),t.ex),a,[])}case"thres":case"match":case"lookup":{const a=t.br.map(u=>this._compute(u,e)),s=j[o](b(a),t.ex),i=[...Array(t.x.length)],c=i[s]=this._compute(t.x[s],e);return n(c.val,i,a)}case"subscript":{const a=this._compute(t.br[0],e);return n(t.ex[a.val],[],[a])}case"vtag":return n(e.tag[t.ex]??"",[],[]);case"tag":{const a=e.with(t.tag),s=this._compute(t.x[0],a);return n(s.val,[s],[],a.tag)}case"dtag":{const a=t.br.map(c=>this._compute(c,e)),s=e.with(Object.fromEntries(a.map((c,u)=>[t.ex[u],c.val]))),i=this._compute(t.x[0],s);return n(i.val,[i],a,s.tag)}case"read":{const a=e.with(t.tag),s=this._gather(a),{pre:i}=s,c=t.ex??"unique";if(s[c])return s[c];if(G()&&c==="unique"&&i.length!==1)throw new Error(`Ill-form read for ${K(a.tag)}`);const u=x[c](b(i),void 0);return s[c]=n(u,i,[],a.tag)}case"custom":{const a=t.x.map(s=>this._compute(s,e));return n(dt[t.ex].calc(b(a)),a,[])}default:I(o)}}markGathered(t,e,n){return n}computeMeta(t,e,n,o,a){}toDebug(){throw"Not implemented"}};function Mt(r,t,e){function n(s,i){if(s.val)return s.val;const c=e(s.tag);return s.val=c?[L(c,i)]:t.nodes.subset(s.id).flatMap(u=>u.op!=="reread"?a(u,s):n(s.with(u.tag),i)),s.val}function o(s,i,c){return s.every(u=>u.op==="const")?w(x[i](s.map(u=>u.ex),c)):{op:i,x:s,br:[]}}function a(s,i){const{op:c}=s;switch(c){case"const":return s;case"read":{const u=n(i.with(s.tag),s.ex);return s.ex===void 0?u[0]??w(void 0):o(u,s.ex,s.ex)}case"sum":case"prod":case"min":case"max":case"sumfrac":{const u=s.x.map(l=>a(l,i));return o(u,c,s.ex)}case"thres":case"match":case"lookup":{const u=s.br.map(l=>a(l,i));if(u.every(l=>l.op==="const")){const l=j[s.op](u.map(m=>m.ex),s.ex);return a(s.x[l],i)}return{...s,x:s.x.map(l=>a(l,i)),br:u}}case"subscript":{const u=a(s.br[0],i);return u.op==="const"?w(s.ex[u.ex]):{...s,br:[u]}}case"vtag":return w(i.tag[s.ex]??"");case"tag":return a(s.x[0],i.with(s.tag));case"dtag":{const u=s.br.map(m=>a(m,i));if(u.some(m=>m.op!=="const"))throw new Error("Dynamic tag must be resolvable during detachment");const l=i.with(Object.fromEntries(u.map((m,h)=>[s.ex[h],m.ex])));return a(s.x[0],l)}case"custom":return{...s,x:s.x.map(u=>a(u,i))};default:I(c)}}return r.map(s=>a(s,new k(t.cache.keys).at({})))}function jt(r,t){const e=new Map;function n(o){const a=e.get(o);if(a)return a;const s=o,i=y(o.x,n),c=y(o.br,n);(o.x!==i||o.br!==c)&&(o={...o,x:i,br:c});const u=t(o,s);return e.set(o,u),u}return y(r,n)}function pt(r,t){const e=new Map;function n(o){const a=e.get(o);if(a)return a;const s=t(o,n);return e.set(o,s),s}return y(r,n)}function Tt(r,t){const e=new Set;function n(o){e.has(o)||(t(o,n),e.add(o))}r.forEach(n)}function y(r,t){const e=r.map(t);return r.every((n,o)=>n===e[o])?r:e}const gt={arithmetic:x,branching:j};class wt extends B{constructor(t,e,n=()=>!0){super(t.cache.keys),this.gathering=new Set,this.nodes=t.nodes,this.tagStr=e,this.filter=n,this.cache=this.cache.with(t.cache.tag)}withTag(t){throw new Error("Unimplemented")}_gather(t){if(this.gathering.has(t))throw new Error("Loop detected");this.gathering.add(t);const e=this.__gather(t);return this.gathering.delete(t),e}__gather(t){if(t.val)return t.val;const e=[];this.nodes._subset(t.id,o=>e.push(...o[U]??[]));const n=this.nodes.subset(t.id).flatMap((o,a)=>o.op==="reread"?this._gather(t.with(o.tag)).pre.map(s=>[s,o,a]):[[this._compute(o,t),o,a]]).map(([o,a,s])=>this.markGathered(t.tag,a,o,e[s]));return t.val={pre:n}}_compute(t,e){try{return super._compute(t,e)}catch(n){return{val:NaN,meta:{formula:`err: ${n.message} in ${this.tagStr(e.tag)}: ${S(t,this.tagStr)}`,deps:[],isRead:!0,toJSON:E(this.tagStr)}}}}markGathered(t,e,{val:n,meta:o},a){return o={...o,readSeq:[...o.readSeq??[],a]},Object.freeze({val:n,meta:o})}computeMeta(t,e,n,o,a){typeof e!="number"?e=`"${e}"`:Math.round(e)===e?e=`${e}`:e=e.toFixed(2);const s={formula:`[${e}] ${S(t,this.tagStr)}`,deps:[...n.map(i=>i==null?void 0:i.meta).filter(i=>!!i),...o.map(i=>i.meta)].flatMap(i=>i.isRead?[i]:i.deps),isRead:t.op==="read",toJSON:E(this.tagStr)};if(t.op==="read"){a=Object.fromEntries(Object.entries(a).filter(([u,l])=>l)),s.deps=n.map(u=>u.meta);const i=s.deps.length;s.deps=s.deps.filter(this.filter);const c=i-s.deps.length;s.formula=`gather ${n.length} node(s) (${c} filtered) for ${this.tagStr(t.tag)} (${this.tagStr(a)})`}return s}}function S(r,t=e=>JSON.stringify(e)){return pt([r],(e,n)=>{const{op:o,tag:a,br:s,x:i}=e;let{ex:c}=e;if(o==="const")return`${c}`;if(o==="read")return t(a,c);o==="subscript"&&(c=void 0);const u=[];return c&&u.push(JSON.stringify(c)),a&&u.push(t(a)),u.push(...s.map(n),...i.map(n)),`${o}(`+u.join(", ")+")"})[0]}function E(r){return function(){const{readSeq:t,formula:e,deps:n}=this;let o;if(t!=null&&t.some(a=>!!a)){const[a,...s]=t;let i="";for(let c=s.length-1;c>=0;c--)if(s[c]){const{tag:u,value:l}=s[c];i+=`${r(u)} <= ${r(l.tag)} : `}else i+="!! : ";o=i+(a?`matches ${r(a.tag)}`:"!!")}return{...o&&{readSeq:o},formula:e,deps:n}}}const{arithmetic:bt}=gt;let yt=class extends B{computeMeta({op:t,ex:e},n,o,a,s){const i={...Object.freeze({conds:Object.freeze({})})},c=o.filter(h=>!!h).map(h=>C(h,i));a.forEach(h=>C(h,i));function u(h,d){return!d.tag&&h?{tag:h,...d}:d}function l(h,d){return u(s,{op:h,ops:d,...i})}function m(h){const d=h.meta,_=d.conds===i.conds;return u(s,_?d:{...d,...i})}if(t==="read"&&e!==void 0){if(e==="min"||e==="max")return m(c.find(h=>h.val===n));t=e,e=void 0}switch(t){case"sum":case"prod":case"min":case"max":case"sumfrac":{let h=c;if(h.length>1){const d=bt[t]([],e);h=h.filter(_=>_.val!==d)}return h.length===1?m(h[0]):h.length===0?l("const",[]):l(t,h)}case"const":case"vtag":case"subscript":return l("const",[]);case"match":case"thres":case"lookup":case"tag":case"dtag":return m(c[0]);case"read":return Object.freeze(m(c[0]));case"custom":return l(e,c);default:H(t)}}markGathered(t,e,n){let o=!1;const a=n.val,s={...Object.freeze(n.meta)};if(t.qt==="cond"){const{src:i,dst:c,sheet:u,q:l}=t;i&&u&&l&&(s.conds={[c??"All"]:{[i]:{[u]:{[l]:a}}}}),o=!0}return Object.freeze(s),o?{val:a,meta:s}:n}listFormulas(t){return this.gather(t.tag).filter(e=>e.val).map(({val:e,meta:n})=>W.withTag(n.tag)[e])}listCondFormulas(t){return this.listFormulas(t).map(e=>this.compute(e).meta.conds).reduce(z,{})}};function C(r,t){const{conds:e,...n}=r.meta;return t.conds=z(t.conds,e),Object.isFrozen(r.meta)?r:{val:r.val,meta:n}}function z(r,t){return F(r,t,(e,n)=>typeof n=="number"?n:void 0)}function F(r,t,e){const n=e(r,t);if(n!==void 0)return n;if(Object.keys(r).length<Object.keys(t).length&&([r,t]=[t,r]),!Object.keys(t).length)return r;let o=!1;const a={...r};for(const[s,i]of Object.entries(t)){const c=a[s],u=s in a?F(c,i,e):i;c!==u&&(a[s]=u,o=!0)}return o?a:r}function vt(r){return t=>!xt(t,r)}function xt(r,t){var a,s;if(!r.formula||!r.deps||r.deps.length<1)return!1;const e=r.formula,n=e.includes("[0]")&&e.includes("common.count")&&t.some(i=>e.includes(i)),o=((a=r.deps[0].formula)==null?void 0:a.includes("gather 0 node"))&&((s=r.deps[0].formula)==null?void 0:s.includes("common.count"));return n&&o}class _t extends yt{toDebug(){return new wt(this,X,vt([...Q,...Y]))}}function St(r,...t){return t.map(({tag:e,value:n})=>({tag:{...e,preset:r},value:n}))}function Et(r,...t){return t.map(({tag:e,value:n})=>({tag:{...e,src:r},value:n}))}function Ct(r,t){const{lvl:e,basic:n,skill:o,ult:a,talent:s,ascension:i,eidolon:c,teamPosition:u}=g.char,{char:l,iso:m,[r.key]:h}=f.withAll("sheet",[]);return[l.reread(h),m.reread(h),e.add(r.level),n.add(r.basic),o.add(r.skill),a.add(r.ult),s.add(r.talent),i.add(r.ascension),c.add(r.eidolon),u.add(t),...Z.map(d=>T.char[`statBoost${d}`].add(r.statBoosts[d]?1:0)),...P.map(d=>T.char[`bonusAbility${d}`].add(r.bonusAbilities[d]?1:0))]}function qt(r,t,e,n){return[f.sheet("agg").reread(f.sheet("lightCone")),g.common.count.sheet(r).add(1),g.lightCone.lvl.add(t),g.lightCone.ascension.add(e),g.lightCone.superimpose.add(n)]}function It(r,t){const{common:{count:e},premod:n}=st(rt,{sheet:"relic",et:"own"});return[f.sheet("agg").reread(f.sheet("relic")),f.withTag({sheet:"relic",qt:"premod"}).reread(f.sheet("dyn")),...Object.entries(r).map(([o,a])=>at(n,o).sheet("dyn").add(a)),...Object.entries(t).map(([o,a])=>e.sheet(o).add(a))]}function Dt(r){const t=f.with("et","team"),{own:e,enemy:n,teamBuff:o,notOwnBuff:a}=f.sheet("agg").withAll("et",[]);return[r.map(s=>f.withTag({et:"target",dst:s}).reread(f.withTag({et:"own",dst:null,src:s}))),r.flatMap(s=>{const i=e.with("src",s);return r.map(c=>i.reread(o.withTag({dst:s,src:c,name:null})))}),r.flatMap(s=>{const i=e.with("src",s);return r.filter(c=>c!==s).map(c=>i.reread(a.withTag({dst:s,src:c,name:null})))}),r.map(s=>n.reread(f.withTag({et:"enemyDeBuff",dst:null,src:s,name:null}))),r.flatMap((s,i)=>{const{stackIn:c,stackTmp:u}=f.withAll("qt",[]),l=f.withTag({src:s,et:"own"});return[l.with("qt","stackTmp").add(tt(c,0,i+1)),l.with("qt","stackOut").add(et(u.max.with("et","team"),i+1,c))]}),r.map(s=>t.add(f.withTag({src:s,et:"own"}).sum))].flat()}function Nt(r){const t=D(v,r);return new _t(v,nt,t)}function At(r){return new mt(v,D(v,r))}function Bt({pathKey:r,iconProps:t={}}){switch(r){case"Abundance":return p(ht,{...t});case"Destruction":return p(lt,{...t});case"Erudition":return p(ut,{...t});case"Harmony":return p(ct,{...t});case"Nihility":return p(it,{...t});case"Preservation":return p(ot,{...t});case"TheHunt":return p($,{...t});case"Remembrance":return p($,{...t})}}export{Bt as P,Et as a,gt as b,Ct as c,Tt as d,dt as e,Mt as f,At as g,qt as l,jt as m,It as r,Nt as s,Dt as t,St as w};
